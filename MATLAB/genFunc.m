function [Y,Xf,Af] = genFunc(X,Xi,~)
%GENFUNC neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 02-May-2018 14:32:07.
% 
% [Y,Xf,Af] = genFunc(X,Xi,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 1xQ matrix, input #1 at timestep ts.
% 
%   Xi = 1x5 cell 1, initial 5 input delay states.
%   Each Xi{1,ts} = 1xQ matrix, initial states for input #1.
% 
%   Ai = 4x0 cell 4, initial 5 layer delay states.
%   Each Ai{1,ts} = 10xQ matrix, initial states for layer #1.
%   Each Ai{2,ts} = 10xQ matrix, initial states for layer #2.
%   Each Ai{3,ts} = 10xQ matrix, initial states for layer #3.
%   Each Ai{4,ts} = 1xQ matrix, initial states for layer #4.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 1xQ matrix, output #1 at timestep ts.
% 
%   Xf = 1x5 cell 1, final 5 input delay states.
%   Each Xf{1,ts} = 1xQ matrix, final states for input #1.
% 
%   Af = 4x0 cell 4, final 0 layer delay states.
%   Each Af{1ts} = 10xQ matrix, final states for layer #1.
%   Each Af{2ts} = 10xQ matrix, final states for layer #2.
%   Each Af{3ts} = 10xQ matrix, final states for layer #3.
%   Each Af{4ts} = 1xQ matrix, final states for layer #4.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = 1;
x1_step1.gain = 0.0202020202020202;
x1_step1.ymin = -1;

% Layer 1
b1 = [2.2605394222291423922;1.6828458705043864985;0.74333328793912978316;-0.61155408480277706484;-0.36456441298719238775;-0.23022801366454273553;-0.27005611368377302473;-1.2564203143625454207;1.7062795883244279427;-2.0459578167653087455];
IW1_1 = [-1.2202017162943084028 0.31580930691268338517 0.99392718369823118696 -1.1904205379705175005 0.94503946149473205818;-1.0642758439926052194 -0.61922746226859304297 -1.0673644913895672381 -0.71595996508699921712 1.0287262480183820834;-1.6267339325894458746 -1.2751001642600552355 0.56627927874284067489 1.2780799988431497116 0.63840915213677140727;0.0024503969994837814135 0.75247690561458202563 1.2742994470675297336 1.1112422868647438001 0.8732711533351185107;1.1672361043247283519 -1.1031318091095601019 0.50575587655567177947 -1.0761746001439440601 -0.34705213666795475813;-0.7535777346595002868 0.98475638784569685669 0.6398262394058984448 0.43757407310220430841 1.4688181721239066402;-1.0091805941732174823 -1.2857300985992774489 -0.33686202633792877714 -1.4745029749264721985 0.94238869896454469099;-0.96219077265528285547 1.319344977567175059 0.75302347265897429107 -0.79087752904639918583 -1.0632067524713675333;1.2120761831284194709 0.3691113727360934571 -1.4912537744713858512 -0.97953155303374228602 -0.56260471991559801719;-1.0276281116472052446 -0.84842867764284635168 -1.213748291854320982 0.69368125545728220871 -0.71201048111139619845];

% Layer 2
b2 = [1.7075412008439332379;-1.3426821014389054287;0.98092403909014358465;0.60925950479918222769;0.18564857956284613882;0.23891344128894656529;0.62396491663952169393;0.9092424861379481138;-1.3749216324878532625;-1.8853723384923877227];
LW2_1 = [-0.73646439326014101479 -0.66188136481460591032 -0.624451273464978307 -0.17734640027505002569 -0.40532920330830840561 -0.98469437177236862624 0.10597538135457312825 -0.54019193576879087626 -0.25424554741850735606 -0.32207287029568892889;0.66491824273378430377 0.56024792900219844149 0.09610311916427406731 0.19044548594255661378 0.91970767794128105432 0.45776522485104637061 -0.083805912235898449847 -0.54526212274937446711 0.2644282173756204446 -0.059323882728421976906;-0.24526608721299611449 -0.537990534086604133 1.031391684918292917 0.025486432270150190249 0.43577840404828471765 -0.63572508953814288457 -0.65802123198220530131 0.34801801292736600502 -0.4236850528566578622 -0.60257975682114350846;-0.60415707412144781241 0.74974862790434593229 0.16861235107075264739 -0.80261170114026114675 -0.061918487664285863648 -0.083282308446801123214 -0.36656925161671788382 0.37479281902611943922 -0.69633709713492708548 0.62766533320743289615;-0.56136813027232923545 0.61746571437385266989 -0.39181911736875452146 -0.56544760010478545276 0.41816866976224703611 -0.19818662282903251604 0.35333890351620561576 0.51961400973368709888 -0.23350729131142863859 0.25754430666989497345;0.87743344327473726807 0.78888942800148909029 -0.87051895787225486156 -0.36641528193895267496 -0.047714685581094672118 0.074393855247174733858 -0.57520466851987295254 0.13786764967571099594 -0.64854958094483206033 -0.65439208859635700222;0.75740927364016286116 0.76472911188259073967 -0.65922597617835010375 0.75844299992642838504 0.079675484007767249928 -0.53574343764435661264 -0.4496839419927701198 0.20586783040543338297 0.29972476983774315462 -0.26315702059988277384;-0.073349934941711575354 -1.0842321419817575467 -0.68791301314365671526 -0.075640738977870811133 -0.054767232438152464724 0.84109546108500454764 0.16963970048041546179 0.12410349557190983316 0.57608947421702516589 0.2761323417857147744;-0.7655444625854742613 0.71187236378740614828 -0.11628230653295254515 0.62892640805537125548 -0.053297984712657876794 -0.70793519351339162515 -0.76566745306201511312 0.56593468132169155727 -0.11536787866546852066 0.42031850124995900897;-0.28603329175809832918 -1.0548696742271894689 -0.299828392146886058 -0.24794504827102889499 0.29669086993511417649 -0.55077997199569694864 -1.011133782932989611 -0.076310706665674632454 0.11760204258808026889 0.54096484454364568428];

% Layer 3
b3 = [-1.7676147128603165726;-1.4102155498556174784;1.0076374634822140575;0.60566462101813434149;-0.034798121883664039078;-0.16598696879310734231;-0.53560050853478946564;0.97404260151170884985;1.2591417257064787538;1.6704427977763753876];
LW3_2 = [0.3864187427348917403 0.60048561680131484763 0.77713839786712002322 -0.65924710435325561964 -0.023420059157074308437 -0.68660468561346177374 -0.059387582393813247161 -0.73805209056926235345 0.44976596817380071203 -0.59874230700473130007;0.76952160221858767475 0.093892272490200850976 0.23168769124508986623 0.84385302378859339267 -0.70091396786153203902 0.58091760487325994067 0.18509937754930302911 -0.43885902670314297369 0.34132372653869164081 -0.43806675991387650226;-0.59970489956303696388 -0.54720879175297121311 0.60838398815708094602 0.30579135912283383902 0.78066250700560591014 0.52596358001683074512 0.46026173635478673241 0.31729935822963778458 0.71580025877767450293 -0.41167790433409950923;-0.85778865597365538953 0.075491283048693319513 -0.29421698593849276993 -0.15209028309250086086 -0.16704011169028909478 0.086716279340900162542 -0.26387912966742088638 -0.11677819387692685293 0.01798165323163465612 -1.4563720435726741353;0.88846754012004913736 0.86408842141993469355 -0.33508301685331065567 0.46399753762726686501 -0.092275661506149991853 -0.83133743539077287199 0.30815636285675623851 -0.0004823042818291247303 -0.44641345760077499882 -0.81440710897746082519;-0.031484348161100496333 -0.49597125888569187913 -0.23045497098671671732 0.11755630681468048904 -0.70147719996708290946 0.77616822269039975613 -0.11339590247685034374 -0.86054916249658441885 0.69000718505581659645 0.29247253016024016281;-0.51316095832425501211 0.30936588942366333166 0.42860236856457467614 0.17569521678455551905 0.10786762581131062455 -0.62738857518322099782 -0.5722150138208507153 -0.81660546979555970193 -0.54474942512201907086 0.69958731605640323004;0.25575335459877923672 0.60061559059318958553 -0.51219484269664306009 0.38994973165986063224 0.70344905153409142962 -0.86007171028581086425 -0.26482232542065142766 -0.32373055302558961799 -0.56698183687210845783 -0.41633781201469405309;1.198024191593430432 -0.06677830813282353839 -0.10469713422897229671 0.32937817014229381352 -0.80344972674488968067 0.35860038506375552236 0.13860394313957216661 -0.48660590338399162258 0.62666792589481723486 0.50099736672585393205;0.62462533643618867174 -0.090074347358474082803 -0.6752665209043290373 0.11580857165650618179 0.28030641791120530781 0.34717675401821584957 -0.64210632806177692089 0.77667880811628198234 -0.34450414338373658296 0.98751988201507567844];

% Layer 4
b4 = 0.23809659154707135675;
LW4_3 = [-0.1454910761554615295 -0.028515002148302763529 -0.096150684662806323866 -0.22292026611926590851 -0.85072416398095607182 0.38988798419725922972 -0.5924861608970769522 -0.55736413681216245841 0.35469197352180220628 0.46070473030535319392];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 0.0202020202020202;
y1_step1.xoffset = 1;

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX
  X = {X};
end
if (nargin < 2), error('Initial input states Xi argument needed.'); end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
  Q = size(X{1},2); % samples/series
elseif ~isempty(Xi)
  Q = size(Xi{1},2);
else
  Q = 0;
end

% Input 1 Delay States
Xd1 = cell(1,6);
for ts=1:5
    Xd1{ts} = mapminmax_apply(Xi{1,ts},x1_step1);
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

      % Rotating delay state position
      xdts = mod(ts+4,6)+1;
    
    % Input 1
    Xd1{xdts} = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    tapdelay1 = cat(1,Xd1{mod(xdts-[1 2 3 4 5]-1,6)+1});
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = tansig_apply(repmat(b3,1,Q) + LW3_2*a2);
    
    % Layer 4
    a4 = repmat(b4,1,Q) + LW4_3*a3;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a4,y1_step1);
end

% Final Delay States
finalxts = TS+(1: 5);
xits = finalxts(finalxts<=5);
xts = finalxts(finalxts>5)-5;
Xf = [Xi(:,xits) X(:,xts)];
Af = cell(4,0);

% Format Output Arguments
if ~isCellX
  Y = cell2mat(Y);
end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
